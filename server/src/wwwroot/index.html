<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Covid-19 Device simulation</title>
    <style>
        html, body, #map {
            display: block;
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <script>
        // Initial values for the Map instance
        const CENTER_LAT = 57.7069;
        const CENTER_LNG = 11.9376;
        const INITIAL_ZOOM = 19;
        const MAP_TYPE = 'satellite'

        const circleStyle = {
            strokeColor: '#112299',
            strokeOpacity: 0.8,
            strokeWeight: 2.0,
            fillColor: '#5599ff',
            fillOpacity: 0.2
        };

        // Store all devices by their name
        const devices = { };

        let ws;
        let map;

        /**
         * Returns a device marker. If the name is already known, returns an existing marker. Otherwise creates a new.
         */
        function getOrCreateDeviceMarker(name) {
            if (name in devices) {
                // This is a known device
                return devices[name];
            }
            else {
                // The name is on the format "device-N". Get the "N" part and use it as a label.
                const label = name.split('-')[1];

                // Create a new marker on the map
                const newDevice = new google.maps.Marker({
                    position: new google.maps.LatLng(CENTER_LAT, CENTER_LNG),
                    title: name,
                    label: label,
                    draggable: true,
                    clickable: true
                });

                newDevice.setMap(map);
                newDevice.addListener('click', () => {
                    console.log(`${name} clicked`);
                });
                newDevice.addListener('dragend', evt => {
                    const newLat = evt.latLng.lat();
                    const newLng = evt.latLng.lng();
                    console.log(`${name} dragged to ${newLat}, ${newLng}`);
                    const message = {
                        'action': 'move',
                        'name': name,
                        'lat': newLat,
                        'lng': newLng
                    };
                    ws.send(JSON.stringify(message));
                });

                // Add the device
                devices[name] = newDevice;

                return newDevice;
            }
        }

        /**
         * Create a circle on the map that grows to 10 meters in radius
         */
        function showBroadcastCircle(lat, lng) {
            // Create a small circle
            const circle = new google.maps.Circle({
                center: new google.maps.LatLng(lat, lng),
                map: map,
                radius: 0.5,
                ...circleStyle
            });

            // Let the circle grow over time
            for (let r = 1; r <= 10; r += 0.5) {
                window.setTimeout(() => {
                    circle.setRadius(r);
                }, r * 95);
            }

            // Remove the circle when it's done
            window.setTimeout(() => circle.setMap(null), 1000);
        }

        /**
         * Connect to the WebSocket endpoint and start communicating
         */
        function connectToWebSocket() {
            // Get the WecSocket URL
            const wsAddress = `ws://${document.location.host}/ws`;
            ws = new WebSocket(wsAddress);

            // Connection was established.
            ws.onopen = evt => {
                console.log('WebSocket connection established.');
            };

            // Connection was closed or broken. Retry connection after a second.
            ws.onclose = evt => {
                console.log('Closed WebSocket connection. Retrying...');
                window.setTimeout(() => connectToWebSocket(), 1000);
            };

            // Incoming message from the server
            ws.onmessage = evt => {
                // Parse the message
                const { name, lat, lng, bearing, action } = JSON.parse(evt.data);

                // Check if the device is known
                const device = getOrCreateDeviceMarker(name);

                switch (action) {
                    case 'move':
                        // Move the marker to the device's new position
                        device.setPosition(new google.maps.LatLng(lat, lng));
                        break;

                    case 'broadcast':
                        // Show a circle on the map that grows over time from 1 meter radius to 10 meter radius
                        showBroadcastCircle(lat, lng);
                        break;

                    case 'receive':
                        console.log(`Device "${name}" received a message`);
                        break;
                }
            };
        }

        /**
         * This function gets called when the Google Maps API has been loaded
         */
        function initMap() {
            // Find the <div id="map"> element
            const mapElement = document.getElementById('map');

            // Create a Map instance showing the selected region
            map = new google.maps.Map(mapElement, {
                center: { lat: CENTER_LAT, lng: CENTER_LNG },
                zoom: INITIAL_ZOOM,
                mapTypeId: MAP_TYPE,
                disableDefaultUI: true
            });

            connectToWebSocket(map);

            return map;
        }
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCngI_6-vhZ0jL8JYsXxuwnFCYkLxTRvUc&callback=initMap"
            async defer></script>
</body>
</html>
