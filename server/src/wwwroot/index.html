<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Covid-19 Device simulation</title>
    <style>
        html, body, #map {
            display: block;
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <script>
        // Initial values for the Map instance
        const CENTER_LAT = 57.7069;
        const CENTER_LNG = 11.9376;
        const INITIAL_ZOOM = 19;
        const MAP_TYPE = 'satellite'

        // Store all devices by their name
        const devices = { };

        function connectToWebSocket(map) {
            // Connect to the websocket endpoint
            const wsAddress = `ws://${document.location.host}/ws`;
            const ws = new WebSocket(wsAddress);

            // Incoming message from the server
            ws.onmessage = evt => {
                // Parse the message
                const { name, lat, lng, bearing, action } = JSON.parse(evt.data);

                // Check if the device is known
                let device = devices[name];

                if (!device) {
                    // This is a new device:

                    // The name is on the format "device-N". Get the "N" part and use it as a label.
                    const label = name.split('-')[1];

                    // Create a new marker on the map
                    device = new google.maps.Marker({
                        position: new google.maps.LatLng(lat, lng),
                        title: name,
                        label: label
                    });
                    device.setMap(map);

                    // Add the device
                    devices[name] = device;
                }

                switch (action) {
                    case 'move':
                        // Move the marker to the device's new position
                        device.setPosition(new google.maps.LatLng(lat, lng));
                        break;

                    case 'broadcast':

                        break;

                    case 'receive':
                        console.log(`Device "${name}" received a message`);
                        break;
                }
            };

            // Connection was closed or broken. Retry connection after a second.
            ws.onclose = evt => {
                console.log('Closed WebSocket connection. Retrying...');
                window.setTimeout(() => connectToWebSocket(map), 1000);
            };

            ws.onopen = evt => {
                console.log('WebSocket connection established.');
            };
        }

        /**
         * This function gets called when the Google Maps API has been loaded
         */
        function initMap() {
            // Find the <div id="map"> element
            const mapElement = document.getElementById('map');

            // Create a Map instance showing the selected region
            const map = new google.maps.Map(mapElement, {
                center: { lat: CENTER_LAT, lng: CENTER_LNG },
                zoom: INITIAL_ZOOM,
                mapTypeId: MAP_TYPE,
                disableDefaultUI: true
            });

            connectToWebSocket(map);
        }
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCngI_6-vhZ0jL8JYsXxuwnFCYkLxTRvUc&callback=initMap"
            async defer></script>
</body>
</html>
